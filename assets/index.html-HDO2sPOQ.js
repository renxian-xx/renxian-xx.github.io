import{_ as n,c as a,a as e,o as l}from"./app-CiE264yX.js";const i="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOwAAABACAYAAAAZDZuBAAADTElEQVR4Xu3dQW7dMAxF0ayxs66hS+8gS2hhpCyY9ylacizbVO4BjJCi7O9Geekwb3+Axb3/ftelst50AVgNgQUKIbBAIQQWKITAAoUQWKAQAgsUQmCBQpYO7I+fv3TpPz/L9l3pKe+x54nfu+9iRmC3M7RLHZ31eAls5ok/dE95jz1V3nNFZwdWzzLLRe+s10tg9SH+t0H04X7uReu994zMtDetz9Je13WvpzPdrzPtbU2/muweHHd2YJWem9c765UGVuu9vqfWPqq1H5mZ6LO0j2rtrY7Won6kbj2ntY5jvmVgtR+ZGV3P7jk6M7q+13vR80f3q9ae6Pn6DO0xZmZg9WyyPpv1IrCu95fOVGt/tHfT2mO1rumF4wis1NrrzOh6ds/RmdH1rO+ZRWtRrzPT2tPzfHzNrMBG56Rr2blq3+NLgdW+p9Y+qrUfmRldz3qttfdfo1r7kfpIjzEzAts6E10fOfceaWCt95df93MVrffeMzKL3knr3t6/n/9q9PnZvmwtminbH80w5uzA+rOJzqi1vjfrsRvYM818NtBydmDv9CmwswM1+/lAZNnAAisisEAhBBYohMAChRBYoBACCxRCYIFCCCxQCIEFCiGwQCEEFiiEwAKFEFigkKUCu/1juLi4alz8D4vlbT/oqyCwWB6BBQohsEAhBBYohMAChRBYoBACCxRCYIFCCCxQCIEFCiGwQCEEFiiEwAKFEFigkKUDm/2FOT/L9l3pjPfofUa274nfG3yYEVj/d16vPO+XwGae+EN55Xtkn/XE7w0+zArsHV4Cqy/if4NEP5St3zDReu89IzPtTeuztLc1rff2We/3+3XP9uk6rnF2YO88xzSwWu/1PbX2Ua39yMxEn6V9q9a+p9Y+qqMe880IrL+u1B1Y7UdmRteze47OjK5nfavWvlVr36qjHvPNCGzWz0Rgk1r7Vq291nrhWmcHVl15pgQ2qbVv1dq3atyDwP6rte+ptY9q7UdmRtezvlVr36q1b9VRj/nODqyeofYzpYG13l9+3c9VtN57z8gseiet9/pWrX00i94r24frnR3YzV1nuhvYM818NtAyI7B3+RTY2YGa/XwgsmxggRURWKAQAgsUQmCBQlYK7F9+DbmItnCoagAAAABJRU5ErkJggg==",p="/assets/%E5%AE%9E%E9%99%85%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%87%8F-Ccl9N9I7.png",t={};function c(o,s){return l(),a("div",null,s[0]||(s[0]=[e(`<p>前段时间发现一个查询很慢的业务，经常要执行十几二十几分钟，甚至有医院反馈有时候转一两个小时都没查出来，但是有时候又很快，几秒钟就能查出来，影响到院内销售数据的上传了。</p><p>于是偶尔抽点时间对其研究了一下，总算是得出结果了，这里记录一下排查过程。</p><p>SQL的大致逻辑为对门诊和住院的药品消耗信息进行查询，关联了病人信息、追溯码等信息，对门诊和住院的不同业务采用了不同的查询，最后将结果使用UNION ALL合并，涉及的表有十几张，SQL有两百多行。大致SQL结构如下：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">SELECT</span>
<span class="line">    ...(表字段、子查询等)</span>
<span class="line">FROM</span>
<span class="line">    ...(七到八张表，包括临时表)</span>
<span class="line">WHERE</span>
<span class="line">    ...(内连表、时间范围、机构等条件)</span>
<span class="line">UNION ALL</span>
<span class="line">SELECT</span>
<span class="line">    ...(表字段、子查询等)</span>
<span class="line">FROM</span>
<span class="line">    ...(七到八张表，包括临时表)</span>
<span class="line">WHERE</span>
<span class="line">    ...(内连表、时间范围、机构等条件)</span>
<span class="line">UNION ALL</span>
<span class="line">SELECT</span>
<span class="line">    ...(表字段、子查询等)</span>
<span class="line">FROM</span>
<span class="line">    ...(七到八张表，包括临时表)</span>
<span class="line">WHERE</span>
<span class="line">    ...(内连表、时间范围、机构等条件)</span>
<span class="line">UNION ALL</span>
<span class="line">SELECT</span>
<span class="line">    ...(表字段、子查询等)</span>
<span class="line">FROM</span>
<span class="line">    ...(七到八张表，包括临时表)</span>
<span class="line">WHERE</span>
<span class="line">    ...(内连表、时间范围、机构等条件)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_1-sql测试" tabindex="-1"><a class="header-anchor" href="#_1-sql测试"><span>1. SQL测试</span></a></h2><p>使用跟踪工具拿到SQL后先是进行简单的测试，使用sqlplus和其他数据库连接工具测试，结果如下：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">SQL&gt; SET TIMING ON;</span>
<span class="line">SQL&gt; SELECT count(0) FROM (...);</span>
<span class="line"></span>
<span class="line">  COUNT(0)</span>
<span class="line">----------</span>
<span class="line">      6008</span>
<span class="line"></span>
<span class="line">已用时间:  00: 00: 00.36</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>便草率地认为SQL没啥问题（最后发现确实也没啥问题），开始转向排查应用服务的问题。</p><h2 id="_2-应用服务排查" tabindex="-1"><a class="header-anchor" href="#_2-应用服务排查"><span>2. 应用服务排查</span></a></h2><p>因为是医保项目，涉及的业务众多，可能会有连接数不够的情况，所以先检查了数据源配置。配置中心的配置如下：</p><p><img src="`+i+`" alt="数据库连接配置.png"></p><p>于是选择了没有业务量的测试集群进行测试，并dump了应用的堆栈情况，查看连接池的情况以及线程卡在了哪里。</p><p>使用如下命令dump堆：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">jmap <span class="token parameter variable">-dump:format</span><span class="token operator">=</span>b,file<span class="token operator">=</span>/root/dump.hprof <span class="token operator">&lt;</span>pid<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>将得到的文件拖入idea中分析，可以看到实际的连接数保持着最小连接数，同时也没有出现内存不足的情况。</p><p><img src="`+p+`" alt="实际连接数量.png"></p><p>连接池没有问题那么就查看线程卡在了哪里，使用如下命令dump线程的执行情况：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">jstack <span class="token operator">&lt;</span>pid<span class="token operator">&gt;</span> <span class="token operator">&gt;</span> dump.txt</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>得到的目标线程的调用栈信息如下：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">&quot;http-nio-9102-exec-14&quot; #248 daemon prio=5 os_prio=0 tid=0x00007f2394006800 nid=0x205ea4 runnable [0x00007f23523eb000]</span>
<span class="line">   java.lang.Thread.State: RUNNABLE</span>
<span class="line">	at java.net.SocketInputStream.socketRead0(Native Method)</span>
<span class="line">	at java.net.SocketInputStream.socketRead(SocketInputStream.java:116)</span>
<span class="line">	at java.net.SocketInputStream.read(SocketInputStream.java:171)</span>
<span class="line">	at java.net.SocketInputStream.read(SocketInputStream.java:141)</span>
<span class="line">	at oracle.net.ns.Packet.receive(Packet.java:311)</span>
<span class="line">	...</span>
<span class="line">	at org.mybatis.spring.SqlSessionTemplate.selectList(SqlSessionTemplate.java:230)</span>
<span class="line">	at org.apache.ibatis.binding.MapperMethod.executeForMany(MapperMethod.java:139)</span>
<span class="line">	at org.apache.ibatis.binding.MapperMethod.execute(MapperMethod.java:76)</span>
<span class="line">	at org.apache.ibatis.binding.MapperProxy.invoke(MapperProxy.java:59)</span>
<span class="line">	at com.sun.proxy.$Proxy802.getInsBillInfoD(Unknown Source)</span>
<span class="line">	at xxx.xxx.xxx.xxx.getInsBillInfo(xxx.java:1720)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到线程卡在了SocketInputStream的socketRead0方法上，说明在等待数据库返回数据，那么问题其实还是出在SQL上。</p><h2 id="_3-sql执行问题分析" tabindex="-1"><a class="header-anchor" href="#_3-sql执行问题分析"><span>3. SQL执行问题分析</span></a></h2><p>通过查询SQL执行记录拿到真正的SQL，可以使用如下语句查询执行记录，SQL_FULLTEXT就是真正的SQL语句了。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">SELECT</span> s<span class="token punctuation">.</span>SID<span class="token punctuation">,</span></span>
<span class="line">       s<span class="token punctuation">.</span><span class="token keyword">SERIAL</span><span class="token comment">#,</span></span>
<span class="line">       sa<span class="token punctuation">.</span>SQL_ID<span class="token punctuation">,</span></span>
<span class="line">       sa<span class="token punctuation">.</span>SQL_FULLTEXT<span class="token punctuation">,</span></span>
<span class="line">       sl<span class="token punctuation">.</span>CHILD_NUMBER<span class="token punctuation">,</span></span>
<span class="line">       sa<span class="token punctuation">.</span>LAST_ACTIVE_TIME<span class="token punctuation">,</span></span>
<span class="line">       s<span class="token punctuation">.</span><span class="token keyword">STATUS</span></span>
<span class="line"><span class="token keyword">FROM</span> v$<span class="token keyword">sql</span> sl</span>
<span class="line">         <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> v$sqlarea sa <span class="token keyword">ON</span> sl<span class="token punctuation">.</span>SQL_ID <span class="token operator">=</span> sa<span class="token punctuation">.</span>SQL_ID</span>
<span class="line">         <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> v$<span class="token keyword">session</span> s <span class="token keyword">ON</span> sa<span class="token punctuation">.</span>hash_value <span class="token operator">=</span> s<span class="token punctuation">.</span>sql_hash_value</span>
<span class="line"><span class="token keyword">WHERE</span> INSTR<span class="token punctuation">(</span>sa<span class="token punctuation">.</span>SQL_FULLTEXT<span class="token punctuation">,</span> <span class="token string">&#39;v$sqlarea&#39;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">  <span class="token operator">AND</span> INSTR<span class="token punctuation">(</span>sa<span class="token punctuation">.</span>SQL_FULLTEXT<span class="token punctuation">,</span> \${<span class="token keyword">SQL</span>}<span class="token punctuation">)</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span></span>
<span class="line"><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> sa<span class="token punctuation">.</span>LAST_ACTIVE_TIME <span class="token keyword">DESC</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于项目中使用了分页插件，可以看到真正执行的SQL大致长下面这个样子（这里做了简化），并且其中包含了绑定变量。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">SELECT</span> TMP_PAGE<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> ROWNUM ROW_ID</span>
<span class="line"><span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> field1<span class="token punctuation">,</span> field2 <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> field1 <span class="token operator">=</span> :<span class="token number">1</span> <span class="token operator">AND</span> field <span class="token operator">=</span> :<span class="token number">2</span><span class="token punctuation">)</span> TMP_PAGE</span>
<span class="line"><span class="token keyword">WHERE</span> ROWNUM <span class="token operator">&lt;=</span> <span class="token number">50</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以通过如下语句拿到SQL绑定的变量</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">SELECT</span> name<span class="token punctuation">,</span> position<span class="token punctuation">,</span> datatype_string<span class="token punctuation">,</span> value_string</span>
<span class="line"><span class="token keyword">FROM</span> v$sql_bind_capture</span>
<span class="line"><span class="token keyword">WHERE</span> sql_id <span class="token operator">=</span> \${SQL_ID}</span>
<span class="line"><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> position<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后使用nodejs采用绑定变量的方式执行SQL，果然很慢，成功复现问题。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">const</span> oradb <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../oradb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">SELECT TMP_PAGE.*, ROWNUM ROW_ID</span>
<span class="line">FROM (SELECT field1, field2 FROM t WHERE field1 = :1 AND field = :2) TMP_PAGE</span>
<span class="line">WHERE ROWNUM &lt;= 50</span>
<span class="line"></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token punctuation">[</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">oradb<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>多次尝试后发现SQL第一次执行很慢（600~800s），后续执行就很快了(&lt;1s)，应该是数据库将对应的数据加载到了共享池中，所以后续查询变快了。</p><p>猜测变量窥探的问题，于是在SQL加上/*+ BIND WARE */，成功改善第一次执行很慢的问题，每次的执行时间几乎保持一致，与未使用绑定变量的情况下相同。</p><p>但是后在后续的测试中发现去掉/*+ BIND WARE */，稍微修改SQL也能达到同样的效果，比如：count(0)改成count(1) ，调整字段顺序，甚至加注释等，SQL执行时间都能大幅度降低。</p><p>于是使用EXPLAIN PLAN FOR查看使用绑定变量的SQL的执行计划，并与未使用绑定变量的SQL的执行计划进行对比。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">--分析SQL执行计划</span></span>
<span class="line"><span class="token keyword">EXPLAIN</span> <span class="token keyword">PLAN</span> <span class="token keyword">FOR</span></span>
<span class="line"><span class="token keyword">SELECT</span> TMP_PAGE<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> ROWNUM ROW_ID</span>
<span class="line"><span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> field1<span class="token punctuation">,</span> field2 <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> field1 <span class="token operator">=</span> :<span class="token number">1</span> <span class="token operator">AND</span> field <span class="token operator">=</span> :<span class="token number">2</span><span class="token punctuation">)</span> TMP_PAGE</span>
<span class="line"><span class="token keyword">WHERE</span> ROWNUM <span class="token operator">&lt;=</span> <span class="token number">50</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">--查看执行计划</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>DBMS_XPLAN<span class="token punctuation">.</span>DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到使用绑定变量的SQL执行计划中，使用了计划基线，而未使用绑定变量的SQL执行计划则是自适应计划。</p><p>使用绑定变量的SQL执行计划：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">&quot;Note&quot;</span>
<span class="line">&quot;-----&quot;</span>
<span class="line">&quot;   - SQL plan baseline SQL_PLAN_06dtmvj5wkaxufd6c22ed used for this statement&quot;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>未使用绑定变量的SQL执行计划：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">&quot;Note&quot;</span>
<span class="line">&quot;-----&quot;</span>
<span class="line">&quot;   - this is an adaptive plan&quot;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过SQL执行记录拿到执行计划：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span></span>
<span class="line"><span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>DBMS_XPLAN<span class="token punctuation">.</span>DISPLAY_CURSOR<span class="token punctuation">(</span>\${SQL_ID}<span class="token punctuation">,</span> \${CHILD_NUMBER}<span class="token punctuation">,</span> <span class="token string">&#39;ALLSTATS LAST&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>果然如此，该SQL使用了计划基线，导致每次执行都使用相同的执行计划，这个计划基线应该是前期数据量少或者数据有倾斜时产生的，已经过时了。</p><h2 id="_4-解决方案" tabindex="-1"><a class="header-anchor" href="#_4-解决方案"><span>4. 解决方案</span></a></h2><p>最终通过删除SQL计划基线来解决了该问题。</p><p>可以通过以下语句查询SQL计划基线：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span></span>
<span class="line"><span class="token keyword">FROM</span> dba_sql_plan_baselines</span>
<span class="line"><span class="token keyword">WHERE</span> INSTR<span class="token punctuation">(</span>SQL_TEXT<span class="token punctuation">,</span> \${<span class="token keyword">SQL</span>}<span class="token punctuation">)</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span></span>
<span class="line"><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> LAST_VERIFIED <span class="token keyword">DESC</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或者</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">SELECT</span> b<span class="token punctuation">.</span><span class="token operator">*</span> </span>
<span class="line"><span class="token keyword">FROM</span> dba_sql_plan_baselines b<span class="token punctuation">,</span> v$<span class="token keyword">sql</span> s</span>
<span class="line"><span class="token keyword">WHERE</span> b<span class="token punctuation">.</span>signature <span class="token operator">=</span> DBMS_SQLTUNE<span class="token punctuation">.</span>SQLTEXT_TO_SIGNATURE<span class="token punctuation">(</span>s<span class="token punctuation">.</span>sql_fulltext<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">AND</span> s<span class="token punctuation">.</span>sql_id <span class="token operator">=</span> \${SQL_ID}<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>删除SQL计划基线：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">BEGIN</span></span>
<span class="line">  DBMS_SPM<span class="token punctuation">.</span>DROP_SQL_PLAN_BASELINE<span class="token punctuation">(</span>sql_handle <span class="token operator">=</span><span class="token operator">&gt;</span> \${SQL_HANDLE}<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">END</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最终测试结果显示，删除SQL计划基线后，SQL执行时间恢复正常。</p><h2 id="_5-疑问" tabindex="-1"><a class="header-anchor" href="#_5-疑问"><span>5. 疑问</span></a></h2><p>其实对比快慢两个SQL的执行计划，发现两者的执行计划差异并不大，慢的SQL执行计划中仅在每一个多层NESTED LOOPS外多了一个FILTER，且条件始终为真。但是在内层循环有条件限制的情况下，最后进行FILTER数据量也不大，因此我感觉目前执行过程的并不是主要因素。</p><p>由于拿不到服务器的密码，也就拿不到跟踪文件，还不敢完全下定论慢是由执行计划的引起的。因为还有一个现象就是使用EXPLAIN PLAN FOR分析执行计划时也很慢(300~500s)，还需进一步探究。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">&quot;----------------------------------------------------------------------------------------------------------------------&quot;</span>
<span class="line">&quot;| Id  | Operation                                             | Name             | E-Rows |  OMem |  1Mem | Used-Mem |&quot;</span>
<span class="line">&quot;----------------------------------------------------------------------------------------------------------------------&quot;</span>
<span class="line">&quot;|   0 | SELECT STATEMENT                                      |                  |        |       |       |          |&quot;</span>
<span class="line">&quot;|*  1 |  COUNT STOPKEY                                        |                  |        |       |       |          |&quot;</span>
<span class="line">&quot;|   2 |   VIEW                                                |                  |      4 |       |       |          |&quot;</span>
<span class="line">&quot;|   3 |    UNION-ALL                                          |                  |        |       |       |          |&quot;</span>
<span class="line">&quot;|   4 |     TABLE ACCESS BY INDEX ROWID                       | TABLE_9          |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*  5 |      INDEX UNIQUE SCAN                                | PK_TABLE_9       |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|   6 |     TABLE ACCESS BY INDEX ROWID BATCHED               | TABLE_10         |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*  7 |      INDEX RANGE SCAN                                 | IDX$$_51450002   |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|   8 |     TABLE ACCESS BY INDEX ROWID                       | TABLE_11         |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*  9 |      INDEX UNIQUE SCAN                                | PK_TABLE_11      |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  10 |     TABLE ACCESS BY INDEX ROWID                       | TABLE_11         |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|* 11 |      INDEX UNIQUE SCAN                                | PK_TABLE_11      |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  12 |     TABLE ACCESS BY INDEX ROWID                       | TABLE_12         |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|* 13 |      INDEX UNIQUE SCAN                                | PK_TABLE_12      |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  14 |     TABLE ACCESS BY INDEX ROWID                       | TABLE_13         |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|* 15 |      INDEX UNIQUE SCAN                                | TABLE_13_PK      |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|* 16 |     FILTER                                            |                  |        |       |       |          |&quot;</span>
<span class="line">&quot;|  17 |      NESTED LOOPS                                     |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  18 |       NESTED LOOPS                                    |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  19 |        NESTED LOOPS                                   |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  20 |         NESTED LOOPS                                  |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  21 |          NESTED LOOPS                                 |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  22 |           NESTED LOOPS                                |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  23 |            NESTED LOOPS                               |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  24 |             NESTED LOOPS                              |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|* 25 |              TABLE ACCESS BY INDEX ROWID BATCHED      | TABLE_1          |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|* 26 |               INDEX RANGE SCAN                        | IDXSF$$_51420008 |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|* 27 |              TABLE ACCESS BY INDEX ROWID              | TABLE_2          |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|* 28 |               INDEX UNIQUE SCAN                       | PK_TABLE_2       |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  29 |             TABLE ACCESS BY INDEX ROWID               | TABLE_3          |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|* 30 |              INDEX UNIQUE SCAN                        | PK_TABLE_3       |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|* 31 |            TABLE ACCESS BY INDEX ROWID                | TABLE_4          |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|* 32 |             INDEX UNIQUE SCAN                         | PK_TABLE_4       |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  33 |           TABLE ACCESS BY INDEX ROWID                 | TABLE_5          |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|* 34 |            INDEX UNIQUE SCAN                          | PK_TABLE_5       |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  35 |          PARTITION RANGE ITERATOR                     |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  36 |           TABLE ACCESS BY LOCAL INDEX ROWID           | TABLE_6          |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|* 37 |            INDEX UNIQUE SCAN                          | PK_TABLE_6       |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|* 38 |         INDEX UNIQUE SCAN                             | PK_TABLE_7       |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  39 |        PARTITION RANGE ITERATOR                       |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|* 40 |         INDEX UNIQUE SCAN                             | PK_TABLE_8       |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|  41 |       TABLE ACCESS BY LOCAL INDEX ROWID               | TABLE_8          |      1 |       |       |          |&quot;</span>
<span class="line">...</span>
<span class="line">&quot;| 117 |     TABLE ACCESS BY INDEX ROWID                       | TABLE_9          |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*118 |      INDEX UNIQUE SCAN                                | PK_TABLE_9       |      1 |       |       |          |&quot;</span>
<span class="line">&quot;| 119 |     TABLE ACCESS BY INDEX ROWID BATCHED               | TABLE_10         |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*120 |      INDEX RANGE SCAN                                 | IDX$$_51450002   |      1 |       |       |          |&quot;</span>
<span class="line">&quot;| 121 |     TABLE ACCESS BY INDEX ROWID                       | TABLE_11         |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*122 |      INDEX UNIQUE SCAN                                | PK_TABLE_11      |      1 |       |       |          |&quot;</span>
<span class="line">&quot;| 123 |     TABLE ACCESS BY INDEX ROWID                       | TABLE_11         |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*124 |      INDEX UNIQUE SCAN                                | PK_TABLE_11      |      1 |       |       |          |&quot;</span>
<span class="line">&quot;| 125 |     TABLE ACCESS BY INDEX ROWID                       | TABLE_12         |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*126 |      INDEX UNIQUE SCAN                                | PK_TABLE_12      |      1 |       |       |          |&quot;</span>
<span class="line">&quot;| 127 |     TABLE ACCESS BY INDEX ROWID                       | TABLE_13         |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*128 |      INDEX UNIQUE SCAN                                | TABLE_13_PK      |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*129 |     FILTER                                            |                  |        |       |       |          |&quot;</span>
<span class="line">&quot;| 130 |      NESTED LOOPS                                     |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;| 131 |       NESTED LOOPS                                    |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;| 132 |        NESTED LOOPS                                   |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;| 133 |         NESTED LOOPS                                  |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*134 |          HASH JOIN                                    |                  |      1 |   787K|   787K|  230K (0)|&quot;</span>
<span class="line">&quot;|*135 |           HASH JOIN                                   |                  |      1 |   935K|   935K| 1297K (0)|&quot;</span>
<span class="line">&quot;|*136 |            HASH JOIN                                  |                  |      1 |  1335K|  1335K| 1680K (0)|&quot;</span>
<span class="line">&quot;| 137 |             TABLE ACCESS BY INDEX ROWID BATCHED       | TABLE_2          |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*138 |              INDEX RANGE SCAN                         | IDXSF$$_51420005 |      1 |       |       |          |&quot;</span>
<span class="line">&quot;| 139 |             TABLE ACCESS BY GLOBAL INDEX ROWID BATCHED| TABLE_14         |      2 |       |       |          |&quot;</span>
<span class="line">&quot;|*140 |              INDEX RANGE SCAN                         | IDX$$_51440009   |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*141 |            TABLE ACCESS FULL                          | TABLE_4          |    113 |       |       |          |&quot;</span>
<span class="line">&quot;|*142 |           TABLE ACCESS BY INDEX ROWID                 | TABLE_1          |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*143 |            INDEX RANGE SCAN                           | IDXSF$$_51420008 |      3 |       |       |          |&quot;</span>
<span class="line">&quot;| 144 |          TABLE ACCESS BY INDEX ROWID                  | TABLE_5          |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*145 |           INDEX UNIQUE SCAN                           | PK_TABLE_5       |      1 |       |       |          |&quot;</span>
<span class="line">&quot;| 146 |         PARTITION RANGE ITERATOR                      |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;| 147 |          TABLE ACCESS BY LOCAL INDEX ROWID            | TABLE_15         |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*148 |           INDEX UNIQUE SCAN                           | PK_TABLE_15      |      1 |       |       |          |&quot;</span>
<span class="line">&quot;| 149 |        PARTITION RANGE ITERATOR                       |                  |      1 |       |       |          |&quot;</span>
<span class="line">&quot;|*150 |         INDEX UNIQUE SCAN                             | PK_TABLE_8       |      1 |       |       |          |&quot;</span>
<span class="line">&quot;| 151 |       TABLE ACCESS BY LOCAL INDEX ROWID               | TABLE_8          |      1 |       |       |          |&quot;</span>
<span class="line">&quot;----------------------------------------------------------------------------------------------------------------------&quot;</span>
<span class="line"></span>
<span class="line">&quot;  16 - filter(:2&gt;=:1)&quot;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,56)]))}const u=n(t,[["render",c]]),r=JSON.parse('{"path":"/bak/oracle-jihuajixianyinqideSQLzhixingwenti/","title":"oracle-计划基线引起的SQL执行问题","lang":"zh-CN","frontmatter":{"title":"oracle-计划基线引起的SQL执行问题","date":"2026/07/16 10:00:00","categories":["oracle","sql"],"tags":["oracle","sql"]},"headers":[{"level":2,"title":"1. SQL测试","slug":"_1-sql测试","link":"#_1-sql测试","children":[]},{"level":2,"title":"2. 应用服务排查","slug":"_2-应用服务排查","link":"#_2-应用服务排查","children":[]},{"level":2,"title":"3. SQL执行问题分析","slug":"_3-sql执行问题分析","link":"#_3-sql执行问题分析","children":[]},{"level":2,"title":"4. 解决方案","slug":"_4-解决方案","link":"#_4-解决方案","children":[]},{"level":2,"title":"5. 疑问","slug":"_5-疑问","link":"#_5-疑问","children":[]}],"git":{"createdTime":null,"updatedTime":null,"contributors":[]},"filePathRelative":"bak/oracle-计划基线引起的SQL执行问题/index.md"}');export{u as comp,r as data};
