import{_ as l,c as t,a as s,b as a,d as p,e as c,r as o,o as i}from"./app-CiE264yX.js";const u={},k={href:"https://github.com/renxian-xx/lua-space.git",target:"_blank",rel:"noopener noreferrer"};function d(r,n){const e=o("ExternalLinkIcon");return i(),t("div",null,[n[2]||(n[2]=s(`<h2 id="一、背景" tabindex="-1"><a class="header-anchor" href="#一、背景"><span>一、背景</span></a></h2><p>以前开发GG(Game Guardian，俗称GG修改器)的Lua脚本时，由于功能很多，在需要对脚本进行加密的情况下，不得不将很多模块塞到一个文件里。</p><p>开发时经常需要在脚本中定义一些全局变量或者文件顶级作用域的局部变量来存储状态或配置，就会导致变量污染问题，而且还有模块界线不清晰的问题。</p><p>如将下面两个模块放在同一个文件中，就会出现变量污染的问题，并且模块界限就变模糊了。</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token comment">-- module1.lua</span></span>
<span class="line">module_var1 <span class="token operator">=</span> <span class="token string">&quot;value1&quot;</span></span>
<span class="line">module_var2 <span class="token operator">=</span> <span class="token string">&quot;value2&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">module_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">print</span><span class="token punctuation">(</span>module_var1<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- module2.lua</span></span>
<span class="line">module_var1 <span class="token operator">=</span> <span class="token string">&quot;value3&quot;</span></span>
<span class="line">module_var2 <span class="token operator">=</span> <span class="token string">&quot;value4&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">module_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">print</span><span class="token punctuation">(</span>module_var1<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="二、初步解决方案" tabindex="-1"><a class="header-anchor" href="#二、初步解决方案"><span>二、初步解决方案</span></a></h2><p>初步的解决方案就是使用表来划分模块，具体采用了如下两种方式：</p><h3 id="_1-使用全局变量" tabindex="-1"><a class="header-anchor" href="#_1-使用全局变量"><span>1. 使用全局变量</span></a></h3><p>这方式虽然将内联到了表内，明确了模块界线，但如果module被重新赋值后，函数中的引用将失效。</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line">module <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">-- 使用全局变量定义一个模块</span></span>
<span class="line">    var1 <span class="token operator">=</span> <span class="token string">&quot;value1&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    var2 <span class="token operator">=</span> <span class="token string">&quot;value2&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    main <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">print</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>var1<span class="token punctuation">)</span> <span class="token comment">-- 使用全局变量来访问模块属性</span></span>
<span class="line">    <span class="token keyword">end</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-使用self关键字" tabindex="-1"><a class="header-anchor" href="#_2-使用self关键字"><span>2. 使用self关键字</span></a></h3><p>这种方式虽然无法将函数内联到表中，但避免了重新赋值导致的函数引用失效的问题。</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> module <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">-- 使用局部变量定义一个模块</span></span>
<span class="line">    var1 <span class="token operator">=</span> <span class="token string">&quot;value1&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    var2 <span class="token operator">=</span> <span class="token string">&quot;value2&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> module<span class="token punctuation">:</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>var1<span class="token punctuation">)</span> <span class="token comment">-- 使用self来访问模块属性</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上两种方式都使用一段时间后，发现始终不太满意，于是开始研究其他的方案。</p><h2 id="三、最终解决方案和原理" tabindex="-1"><a class="header-anchor" href="#三、最终解决方案和原理"><span>三、最终解决方案和原理</span></a></h2><p>最终我采用代理函数上值（upvalue）中的_ENV来实现函数直接访问模块属性。</p><p>当在表中定义函数main时，由于函数所处的作用域中没有变量key，Lua会在递归向上层作用域中查找变量key，最终会在_ENV中进行查找变量key。</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> module <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    key <span class="token operator">=</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    main <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">local</span> tmp <span class="token operator">=</span> key</span>
<span class="line">    <span class="token keyword">end</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 遍历函数的上值，源码中最多65536个上值</span></span>
<span class="line"><span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">65536</span> <span class="token keyword">do</span></span>
<span class="line">    <span class="token keyword">local</span> name<span class="token punctuation">,</span> value <span class="token operator">=</span> debug<span class="token punctuation">.</span><span class="token function">getupvalue</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>main<span class="token punctuation">,</span> i<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    <span class="token function">print</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value <span class="token operator">==</span> _ENV<span class="token punctuation">)</span> <span class="token comment">-- 输出：_ENV	true</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>_ENV是一个特殊的表，代表的是Lua的全局环境，访问_ENV中的变量，也就是访问全局变量，不需要显示引用。</p><p>并且无论_ENV中有没有key都会将_ENV添加到函数的上值中，如果上值中没有_ENV，则说明在向上查找过程中找到变量key（非_ENV内）。</p><p>我们可以通过debug.upvaluejoin修改函数的上值中_ENV的值，将其替换为函数所处的表，当函数内部作用域没有找到变量key，就会在表中查找，省去了显示引用。</p><h2 id="四、代码实现" tabindex="-1"><a class="header-anchor" href="#四、代码实现"><span>四、代码实现</span></a></h2>`,22)),a("p",null,[n[1]||(n[1]=p("为减少篇幅，这里仅展示删减的代码，完整版本参见Github地址：")),a("a",k,[n[0]||(n[0]=p("lua-space")),c(e)])]),n[3]||(n[3]=s(`<h3 id="_1-第一版" tabindex="-1"><a class="header-anchor" href="#_1-第一版"><span>1. 第一版</span></a></h3><p>第一版是直接访问表属性，代码如下：</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"></span>
<span class="line">SetEnvHandler <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> handler<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">65536</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token keyword">local</span> name<span class="token punctuation">,</span> upvalue <span class="token operator">=</span> debug<span class="token punctuation">.</span><span class="token function">getupvalue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> i<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">&quot;_ENV&quot;</span> <span class="token keyword">then</span></span>
<span class="line">            <span class="token comment">-- 对_ENV进行代理</span></span>
<span class="line">            <span class="token keyword">local</span> proxy_env <span class="token operator">=</span> <span class="token function">setmetatable</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">                __index <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> k<span class="token punctuation">)</span></span>
<span class="line">                    <span class="token keyword">return</span> handler<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>upvalue<span class="token punctuation">,</span> k<span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">end</span><span class="token punctuation">;</span></span>
<span class="line">                __newindex <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span></span>
<span class="line">                    handler<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>upvalue<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">end</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">-- 创建一个闭包，使其第一个上值为proxy_env</span></span>
<span class="line">            <span class="token keyword">local</span> proxy_closure <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">local</span> _ <span class="token operator">=</span> proxy_env</span>
<span class="line">            <span class="token keyword">end</span></span>
<span class="line">            debug<span class="token punctuation">.</span><span class="token function">upvaluejoin</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> i<span class="token punctuation">,</span> proxy_closure<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">-- 使用proxy_closure的第一个上值替换_ENV</span></span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line">        <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">or</span> name <span class="token operator">==</span> <span class="token string">&quot;_ENV&quot;</span> <span class="token keyword">then</span></span>
<span class="line">            <span class="token keyword">break</span></span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    <span class="token keyword">return</span> value</span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 模块创建函数</span></span>
<span class="line">Space <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">local</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        get <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> key<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> instance<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">or</span> env<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token comment">-- 如果在instance中找不到，则从_ENV中查找</span></span>
<span class="line">        <span class="token keyword">end</span><span class="token punctuation">;</span></span>
<span class="line">        set <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>
<span class="line">            instance<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value <span class="token comment">-- 将设置全局变量的操作代理到instance中</span></span>
<span class="line">        <span class="token keyword">end</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> _<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token comment">-- 如果value是函数，则进行_ENV的代理</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token keyword">then</span></span>
<span class="line">            <span class="token function">SetEnvHandler</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> handler<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">setmetatable</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        __index <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> key<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> instance<span class="token punctuation">[</span>key<span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">end</span><span class="token punctuation">;</span></span>
<span class="line">        __newindex <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">--对新增属性进行处理</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token keyword">then</span></span>
<span class="line">                value <span class="token operator">=</span> <span class="token function">SetEnvHandler</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> instance<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">end</span></span>
<span class="line">            instance<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value</span>
<span class="line">        <span class="token keyword">end</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用效果：</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> module <span class="token operator">=</span> <span class="token function">Space</span> <span class="token punctuation">{</span></span>
<span class="line">    key <span class="token operator">=</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    main <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">-- 访问模块属性</span></span>
<span class="line">        <span class="token function">print</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token comment">-- value</span></span>
<span class="line">        <span class="token comment">-- 修改模块属性</span></span>
<span class="line">        key <span class="token operator">=</span> <span class="token string">&quot;new_value&quot;</span></span>
<span class="line">        <span class="token function">print</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token comment">-- new_value</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">-- 判断是否有全局变量key</span></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token comment">-- nil</span></span>
<span class="line"><span class="token comment">-- 访问模块属性</span></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token comment">-- new_value</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这版虽然满足了我的需求，但这里面有些问题：</p><ol><li>在进行全局变量创建或修改时会被代理到指定的表中，这是不符合预期的。同样的在外层作用域出现同名局部变量时，访问和修改都会指向该局部变量。</li><li>需要对每个函数都进行_ENV的代理，需要占用更多内存。</li></ol><p>当然这版有一个好处就是外层作用域会随着_ENV扩散到内层，例如：</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> module <span class="token operator">=</span> <span class="token function">Space</span> <span class="token punctuation">{</span></span>
<span class="line">    key <span class="token operator">=</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    main <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">local</span> inner_module <span class="token operator">=</span> <span class="token function">Space</span> <span class="token punctuation">{</span></span>
<span class="line">            main <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token function">print</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token comment">-- 可以访问到外层作用域的key</span></span>
<span class="line">            <span class="token keyword">end</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        inner_module<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- 调用内层模块的main函数</span></span>
<span class="line">    <span class="token keyword">end</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-第二版" tabindex="-1"><a class="header-anchor" href="#_2-第二版"><span>2. 第二版</span></a></h3><p>第二版引入了自定义的关键字，<code>this</code>指向当前模块，<code>super</code>指向父模块，由于不再直接访问模块属性，所有的函数都可以使用同一个代理。</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line">SetEnvProxy <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> proxy_closure<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">65536</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token keyword">local</span> name<span class="token punctuation">,</span> upvalue <span class="token operator">=</span> debug<span class="token punctuation">.</span><span class="token function">getupvalue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> i<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">&quot;_ENV&quot;</span> <span class="token keyword">then</span></span>
<span class="line">            debug<span class="token punctuation">.</span><span class="token function">upvaluejoin</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> i<span class="token punctuation">,</span> proxy_closure<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">-- 使用proxy_closure的第一个上值替换_ENV</span></span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line">        <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">or</span> name <span class="token operator">==</span> <span class="token string">&quot;_ENV&quot;</span> <span class="token keyword">then</span></span>
<span class="line">            <span class="token keyword">break</span></span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    <span class="token keyword">return</span> value</span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line">Space <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> parent<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">local</span> proxy_instance</span>
<span class="line">    <span class="token keyword">local</span> handle_keyword_index <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> key <span class="token operator">==</span> <span class="token string">&quot;this&quot;</span> <span class="token keyword">then</span></span>
<span class="line">            <span class="token keyword">return</span> proxy_instance</span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line">        <span class="token keyword">if</span> key <span class="token operator">==</span> <span class="token string">&quot;super&quot;</span> <span class="token keyword">then</span></span>
<span class="line">            <span class="token keyword">return</span> parent</span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    <span class="token keyword">local</span> handle_keyword_newindex <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> key <span class="token operator">==</span> <span class="token string">&quot;this&quot;</span> <span class="token keyword">then</span></span>
<span class="line">            <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot rewrite &#39;this&#39;&quot;</span><span class="token punctuation">)</span> <span class="token comment">-- 禁止重写this</span></span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line">        <span class="token keyword">if</span> key <span class="token operator">==</span> <span class="token string">&quot;super&quot;</span> <span class="token keyword">then</span></span>
<span class="line">            <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot rewrite &#39;super&#39;&quot;</span><span class="token punctuation">)</span> <span class="token comment">-- 禁止重写super</span></span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    <span class="token keyword">local</span> proxy_env <span class="token operator">=</span> <span class="token function">setmetatable</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        __index <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> key<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">handle_keyword_index</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword">or</span> _ENV<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token comment">-- 否则返回_ENV中的对应值</span></span>
<span class="line">        <span class="token keyword">end</span><span class="token punctuation">;</span></span>
<span class="line">        __newindex <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">handle_keyword_newindex</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span></span>
<span class="line">            _ENV<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value</span>
<span class="line">        <span class="token keyword">end</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">-- 创建一个闭包，使其第一个上值为proxy_env</span></span>
<span class="line">    <span class="token keyword">local</span> proxy_closure <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">local</span> _ <span class="token operator">=</span> proxy_env</span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">-- 对instance的操作代理</span></span>
<span class="line">    proxy_instance <span class="token operator">=</span> <span class="token function">setmetatable</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        __index <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> key<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">handle_keyword_index</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword">or</span> instance<span class="token punctuation">[</span>key<span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">end</span><span class="token punctuation">;</span></span>
<span class="line">        __newindex <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">handle_keyword_newindex</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token keyword">then</span></span>
<span class="line">                value <span class="token operator">=</span> <span class="token function">SetEnvProxy</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> proxy_closure<span class="token punctuation">)</span> <span class="token comment">-- 如果value是函数，则设置_ENV</span></span>
<span class="line">            <span class="token keyword">end</span></span>
<span class="line">            instance<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value <span class="token comment">-- 将设置全局变量的操作代理到instance中</span></span>
<span class="line">        <span class="token keyword">end</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> _<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token keyword">then</span></span>
<span class="line">            <span class="token function">SetEnvProxy</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> proxy_closure<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    <span class="token keyword">return</span> proxy_instance</span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用效果如下：</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line">key <span class="token operator">=</span> <span class="token string">&quot;global_value&quot;</span></span>
<span class="line"><span class="token keyword">local</span> module <span class="token operator">=</span> <span class="token function">Space</span> <span class="token punctuation">{</span></span>
<span class="line">    key <span class="token operator">=</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    main <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">-- 访问全局变量</span></span>
<span class="line">        <span class="token function">print</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token comment">-- global_value</span></span>
<span class="line">        <span class="token comment">-- 修改全局变量</span></span>
<span class="line">        key <span class="token operator">=</span> <span class="token string">&quot;new_global_value&quot;</span></span>
<span class="line">        <span class="token function">print</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token comment">-- new_global_value</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">-- 访问模块属性</span></span>
<span class="line">        <span class="token function">print</span><span class="token punctuation">(</span>this<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token comment">-- value</span></span>
<span class="line">        <span class="token comment">-- 修改模块属性</span></span>
<span class="line">        this<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">&quot;new_value&quot;</span></span>
<span class="line">        <span class="token function">print</span><span class="token punctuation">(</span>this<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token comment">-- new_value</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">-- 内部新增函数</span></span>
<span class="line">        this<span class="token punctuation">.</span>inner_test <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">print</span><span class="token punctuation">(</span>this<span class="token punctuation">.</span>key<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">end</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function">inner_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- new_value</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 外部新增函数</span></span>
<span class="line">module<span class="token punctuation">.</span>outer_test <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">print</span><span class="token punctuation">(</span>this<span class="token punctuation">.</span>key<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function">outer_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- new_value</span></span>
<span class="line"></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token comment">-- new_value</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这一版的变量访问变得很明确，将全局变量和模块属性区分开了，在模块内容动态修改方面也更加灵活，在后续主要使用的也是这个版本。</p>`,15))])}const m=l(u,[["render",d]]),b=JSON.parse('{"path":"/blogs/lua/lua-tongguoshezhibibaoupvalueshixianfunctionzhijiefangwentableshuxing/","title":"lua-通过设置闭包upvalue实现function直接访问table属性","lang":"zh-CN","frontmatter":{"title":"lua-通过设置闭包upvalue实现function直接访问table属性","date":"2025/08/07 00:00:00","tags":["Lua"]},"headers":[{"level":2,"title":"一、背景","slug":"一、背景","link":"#一、背景","children":[]},{"level":2,"title":"二、初步解决方案","slug":"二、初步解决方案","link":"#二、初步解决方案","children":[{"level":3,"title":"1. 使用全局变量","slug":"_1-使用全局变量","link":"#_1-使用全局变量","children":[]},{"level":3,"title":"2. 使用self关键字","slug":"_2-使用self关键字","link":"#_2-使用self关键字","children":[]}]},{"level":2,"title":"三、最终解决方案和原理","slug":"三、最终解决方案和原理","link":"#三、最终解决方案和原理","children":[]},{"level":2,"title":"四、代码实现","slug":"四、代码实现","link":"#四、代码实现","children":[{"level":3,"title":"1. 第一版","slug":"_1-第一版","link":"#_1-第一版","children":[]},{"level":3,"title":"2. 第二版","slug":"_2-第二版","link":"#_2-第二版","children":[]}]}],"git":{"createdTime":1754564473000,"updatedTime":1754579045000,"contributors":[{"name":"renxian","email":"2275568171@qq.com","commits":3}]},"filePathRelative":"blogs/lua/lua-通过设置闭包upvalue实现function直接访问table属性/index.md"}');export{m as comp,b as data};
