import{_ as l,c as o,b as s,a as t,d as a,e,r as c,o as i}from"./app-CiE264yX.js";const u="/assets/%E6%B7%BB%E5%8A%A0%E5%8F%8D%E7%BC%96%E8%AF%91%E7%A8%8B%E5%BA%8F%E9%9B%86-CHym0hwZ.png",k={},r={href:"https://harmony.pardeike.net/articles/intro.html",target:"_blank",rel:"noopener noreferrer"},d={href:"https://steamcommunity.com/workshop/filedetails/?id=2009463077",target:"_blank",rel:"noopener noreferrer"};function m(v,n){const p=c("ExternalLinkIcon");return i(),o("div",null,[n[5]||(n[5]=s("p",null,"本节介绍使用Harmony库对环世界的方法进行打补丁，同样会以一个简单的案例来说明如何使用Harmony库。",-1)),n[6]||(n[6]=s("h2",{id:"一、harmony库简介",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#一、harmony库简介"},[s("span",null,"一、Harmony库简介")])],-1)),n[7]||(n[7]=s("p",null,"Harmony是利用C#的反射和IL代码修改技术，能够在运行时替换、修补、装饰.NET方法的库。其能够为方法添加前置补丁、后置补丁和辅助补丁，在方法补丁无法生效的情况下，还可以使转译器修改IL字节码。",-1)),s("p",null,[n[1]||(n[1]=a("详细的API说明和用例参见Harmony官网地址：")),s("a",r,[n[0]||(n[0]=a("Harmony官网")),e(p)])]),n[8]||(n[8]=t(`<h2 id="二、创建模组" tabindex="-1"><a class="header-anchor" href="#二、创建模组"><span>二、创建模组</span></a></h2><p>本次案例是做一个对人物技能增强的模组，让技能为小人带来更多的增益效果，如：让格斗等级能够缩短近战的冷却时间。模组目录结构如下：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">MyCombatExtend</span>
<span class="line"> - About</span>
<span class="line">   - About.xml</span>
<span class="line"> - Assemblies</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="三、编写补丁" tabindex="-1"><a class="header-anchor" href="#三、编写补丁"><span>三、编写补丁</span></a></h2><h3 id="_1-安装harmony模组" tabindex="-1"><a class="header-anchor" href="#_1-安装harmony模组"><span>1. 安装Harmony模组</span></a></h3>`,5)),s("p",null,[n[3]||(n[3]=a("在Steam创意工坊中订阅：")),s("a",d,[n[2]||(n[2]=a("Harmony")),e(p)]),n[4]||(n[4]=a("，订阅后可以直接添加到游戏的模组列表内。"))]),n[9]||(n[9]=t(`<h3 id="_2-编写about-xml文件" tabindex="-1"><a class="header-anchor" href="#_2-编写about-xml文件"><span>2. 编写About.xml文件</span></a></h3><p>在<code>About\\About.xml</code>文件中写入以下内容：</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ModMetaData</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>我的战斗拓展<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!--模组名称--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>我的战斗拓展<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!--模组描述--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>author</span><span class="token punctuation">&gt;</span></span>RenXian<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>author</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!--作者--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>supportedVersions</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!--支持的版本--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>1.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>1.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>supportedVersions</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packageId</span><span class="token punctuation">&gt;</span></span>RenXian.MyCombatExtend<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packageId</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!--包名--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modDependencies</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!--模组依赖，声明你的模块依赖了哪些其他的模板，以便于其他玩家去下载--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packageId</span><span class="token punctuation">&gt;</span></span>brrainz.harmony<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packageId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>displayName</span><span class="token punctuation">&gt;</span></span>Harmony<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>displayName</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>downloadUrl</span><span class="token punctuation">&gt;</span></span>https://steamcommunity.com/workshop/filedetails/?id=2009463077<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>downloadUrl</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>steamWorkshopUrl</span><span class="token punctuation">&gt;</span></span>https://steamcommunity.com/workshop/filedetails/?id=2009463077<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>steamWorkshopUrl</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modDependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ModMetaData</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-创建c-项目" tabindex="-1"><a class="header-anchor" href="#_3-创建c-项目"><span>3. 创建C#项目</span></a></h3><p>在创建<code>MyCombatExtend</code>目录下一个C#类库项目，命名为<code>MyCombatExtendSource</code>，创建过程参加第二节的内容。</p><h3 id="_4-添加harmony库引用" tabindex="-1"><a class="header-anchor" href="#_4-添加harmony库引用"><span>4. 添加Harmony库引用</span></a></h3><p>引入模组列表中的Harmony库，通常位于<code>Steam安装目录\\steamapps\\workshop\\content\\294100\\2009463077\\Current\\Assemblies</code>目录下。</p><p>可以直接在.csproj文件中添加引用：</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Reference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0Harmony<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HintPath</span><span class="token punctuation">&gt;</span></span>..\\..\\..\\..\\..\\workshop\\content\\294100\\2009463077\\Current\\Assemblies\\0Harmony.dll<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HintPath</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Private</span><span class="token punctuation">&gt;</span></span>False<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Private</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Reference</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-反编译查看目标方法逻辑" tabindex="-1"><a class="header-anchor" href="#_5-反编译查看目标方法逻辑"><span>5. 反编译查看目标方法逻辑</span></a></h3><p>使用Rider的反编译功能添加<code>Assembly-CSharp.dll</code>查看<code>VerbProperties.AdjustedCooldown</code>方法的逻辑，了解其参数和返回值。</p><p><img src="`+u+`" alt="添加反编译程序集.png"></p><p>反编译得到的代码如下：</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs" data-title="cs"><pre><code><span class="line"><span class="token comment">//tool指的是近战攻击时使用的具体部位，比如拳头、牙齿、刀尖，equipment则是指使用的武器，比如：玻璃钢匕首、速射机枪</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">float</span></span> <span class="token function">AdjustedCooldown</span><span class="token punctuation">(</span><span class="token class-name">Tool</span> tool<span class="token punctuation">,</span> <span class="token class-name">Pawn</span> attacker<span class="token punctuation">,</span> <span class="token class-name">Thing</span> equipment<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token class-name"><span class="token keyword">float</span></span> num <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultCooldownTime<span class="token punctuation">;</span> <span class="token comment">//Def中定义的默认冷却时间</span></span>
<span class="line">  <span class="token comment">//如果有tool则说明是近战攻击，计算equipment的冷却时间，equipment为空时，冷却时间则使用Defs中定义的冷却时间*1.0</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>tool <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> </span>
<span class="line">    num <span class="token operator">=</span> tool<span class="token punctuation">.</span><span class="token function">AdjustedCooldown</span><span class="token punctuation">(</span>equipment<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//如果没有tool，则说明是远程攻击，使用equipment的冷却时间</span></span>
<span class="line">  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>equipment <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>IsMeleeAttack<span class="token punctuation">)</span></span>
<span class="line">    num <span class="token operator">=</span> equipment<span class="token punctuation">.</span><span class="token function">GetStatValue</span><span class="token punctuation">(</span>StatDefOf<span class="token punctuation">.</span>RangedWeapon_Cooldown<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>attacker <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//应用冷却因子，这个在自定义的时候可以设置</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>IsMeleeAttack<span class="token punctuation">)</span></span>
<span class="line">      num <span class="token operator">*=</span> attacker<span class="token punctuation">.</span><span class="token function">GetStatValue</span><span class="token punctuation">(</span>StatDefOf<span class="token punctuation">.</span>MeleeCooldownFactor<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">      num <span class="token operator">*=</span> attacker<span class="token punctuation">.</span><span class="token function">GetStatValue</span><span class="token punctuation">(</span>StatDefOf<span class="token punctuation">.</span>RangedCooldownFactor<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> num<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//重载方法，这里多了一个equipmentStuff参数，通常是指武器的材质</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">float</span></span> <span class="token function">AdjustedCooldown</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token class-name">Tool</span> tool<span class="token punctuation">,</span></span>
<span class="line">  <span class="token class-name">Pawn</span> attacker<span class="token punctuation">,</span></span>
<span class="line">  <span class="token class-name">ThingDef</span> equipment<span class="token punctuation">,</span></span>
<span class="line">  <span class="token class-name">ThingDef</span> equipmentStuff<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token class-name"><span class="token keyword">float</span></span> num <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultCooldownTime<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//这里同理，只是增加了对equipmentStuff的处理</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>tool <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></span>
<span class="line">    num <span class="token operator">=</span> tool<span class="token punctuation">.</span><span class="token function">AdjustedCooldown</span><span class="token punctuation">(</span>equipment<span class="token punctuation">,</span> equipmentStuff<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>equipment <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>IsMeleeAttack<span class="token punctuation">)</span></span>
<span class="line">    num <span class="token operator">=</span> equipment<span class="token punctuation">.</span><span class="token function">GetStatValueAbstract</span><span class="token punctuation">(</span>StatDefOf<span class="token punctuation">.</span>RangedWeapon_Cooldown<span class="token punctuation">,</span> equipmentStuff<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//同上，应用冷却因子</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>attacker <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>IsMeleeAttack<span class="token punctuation">)</span></span>
<span class="line">      num <span class="token operator">*=</span> attacker<span class="token punctuation">.</span><span class="token function">GetStatValue</span><span class="token punctuation">(</span>StatDefOf<span class="token punctuation">.</span>MeleeCooldownFactor<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">      num <span class="token operator">*=</span> attacker<span class="token punctuation">.</span><span class="token function">GetStatValue</span><span class="token punctuation">(</span>StatDefOf<span class="token punctuation">.</span>RangedCooldownFactor<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> num<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-编写补丁代码" tabindex="-1"><a class="header-anchor" href="#_6-编写补丁代码"><span>6. 编写补丁代码</span></a></h3><p>根据上面分析的逻辑，我们需要对冷却时间的最终结果乘以受格斗技能等级影响的系数。格斗技能每升一级，冷却时间降低2.5%。</p><p>因此可以对<code>VerbProperties.AdjustedCooldown</code>添加一个后置补丁，来修改冷却时间的最终计算结果。</p><p>在项目中创建一个类，命名为<code>Patch_MyCombatExtend</code>，并编写以下代码：</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs" data-title="cs"><pre><code><span class="line"><span class="token keyword">using</span> <span class="token namespace">HarmonyLib</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">using</span> <span class="token namespace">RimWorld</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">using</span> <span class="token namespace">Verse</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">namespace</span> <span class="token namespace">MyCombatExtendSource</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">StaticConstructorOnStartup</span></span><span class="token punctuation">]</span> <span class="token comment">// 在游戏启动时加载此类</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Patch_MyCombatExtend</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//静构造函数，启动时调用该函数</span></span>
<span class="line">    <span class="token keyword">static</span> <span class="token function">Patch_MyCombatExtend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Harmony</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>Patch_MyCombatExtend<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PatchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建Harmony实例并应用所有补丁</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//近战冷却时间随近战技能等级降低，每级降低2.5%</span></span>
<span class="line">    <span class="token comment">//对VerbProperties.AdjustedCooldown方法进行补丁，该方法用于计算攻击的冷却时间</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HarmonyPatch</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">VerbProperties</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token comment">//目标类</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HarmonyPatch</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>VerbProperties<span class="token punctuation">.</span>AdjustedCooldown<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token comment">//目标方法</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HarmonyPatch</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Tool</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Pawn</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Thing</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token comment">//目标方法的参数类型列表</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Patch_CooldownMultiplier1</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HarmonyPostfix</span></span><span class="token punctuation">]</span> <span class="token comment">//后置补丁，在目标方法执行后调用</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Postfix</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name"><span class="token keyword">float</span></span> __result<span class="token punctuation">,</span> <span class="token class-name">VerbProperties</span> __instance<span class="token punctuation">,</span> <span class="token class-name">Pawn</span> attacker<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>attacker <span class="token operator">!=</span> <span class="token keyword">null</span></span>
<span class="line">                <span class="token operator">&amp;&amp;</span> attacker<span class="token punctuation">.</span>skills <span class="token operator">!=</span> <span class="token keyword">null</span></span>
<span class="line">                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>attacker<span class="token punctuation">.</span>skills<span class="token punctuation">.</span><span class="token function">GetSkill</span><span class="token punctuation">(</span>SkillDefOf<span class="token punctuation">.</span>Melee<span class="token punctuation">)</span><span class="token punctuation">.</span>TotallyDisabled</span>
<span class="line">                <span class="token operator">&amp;&amp;</span> __instance<span class="token punctuation">.</span>IsMeleeAttack<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//如果攻击者存在没有被禁用的格斗技能，并且当前动作是近战攻击时，我们让最终的冷却时间受格斗技能影响</span></span>
<span class="line">                __result <span class="token operator">*=</span> <span class="token number">1</span> <span class="token operator">-</span> attacker<span class="token punctuation">.</span>skills<span class="token punctuation">.</span><span class="token function">GetSkill</span><span class="token punctuation">(</span>SkillDefOf<span class="token punctuation">.</span>Melee<span class="token punctuation">)</span><span class="token punctuation">.</span>Level <span class="token operator">*</span> <span class="token number">0.025f</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//对AdjustedCooldown的重载方法进行补丁，逻辑同上</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HarmonyPatch</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">VerbProperties</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HarmonyPatch</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>VerbProperties<span class="token punctuation">.</span>AdjustedCooldown<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HarmonyPatch</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Tool</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Pawn</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ThingDef</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ThingDef</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Patch_CooldownMultiplier2</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HarmonyPostfix</span></span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Postfix</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name"><span class="token keyword">float</span></span> __result<span class="token punctuation">,</span> <span class="token class-name">VerbProperties</span> __instance<span class="token punctuation">,</span> <span class="token class-name">Pawn</span> attacker<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>attacker <span class="token operator">!=</span> <span class="token keyword">null</span></span>
<span class="line">                <span class="token operator">&amp;&amp;</span> attacker<span class="token punctuation">.</span>skills <span class="token operator">!=</span> <span class="token keyword">null</span></span>
<span class="line">                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>attacker<span class="token punctuation">.</span>skills<span class="token punctuation">.</span><span class="token function">GetSkill</span><span class="token punctuation">(</span>SkillDefOf<span class="token punctuation">.</span>Melee<span class="token punctuation">)</span><span class="token punctuation">.</span>TotallyDisabled</span>
<span class="line">                <span class="token operator">&amp;&amp;</span> __instance<span class="token punctuation">.</span>IsMeleeAttack<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                __result <span class="token operator">*=</span> <span class="token number">1</span> <span class="token operator">-</span> attacker<span class="token punctuation">.</span>skills<span class="token punctuation">.</span><span class="token function">GetSkill</span><span class="token punctuation">(</span>SkillDefOf<span class="token punctuation">.</span>Melee<span class="token punctuation">)</span><span class="token punctuation">.</span>Level <span class="token operator">*</span> <span class="token number">0.025f</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-编译项目并测试" tabindex="-1"><a class="header-anchor" href="#_7-编译项目并测试"><span>7. 编译项目并测试</span></a></h3><p>同第二节一样，编译项目后便会在<code>Assemblies</code>目录下生成dll文件，由于效果不太明显，这里就不放效果图了，可自行测试。</p><h2 id="四、总结" tabindex="-1"><a class="header-anchor" href="#四、总结"><span>四、总结</span></a></h2><p>本节介绍了如何使用Harmony库对环世界的代码进行打补丁，创建了一个简单的模组来增强近战技能的效果。通过对 <code>VerbProperties.AdjustedCooldown</code>方法的补丁，实现了根据近战技能等级来降低近战攻击的冷却时间。</p>`,23))])}const g=l(k,[["render",m]]),y=JSON.parse('{"path":"/blogs/rimword-mod/3/3.html","title":"环世界模组开发 - 3. Harmony补丁开发","lang":"zh-CN","frontmatter":{"title":"环世界模组开发 - 3. Harmony补丁开发","date":"2025/06/29 10:00:03","categories":["环世界模组开发"],"tags":["RimWorld","Mod"]},"headers":[{"level":2,"title":"一、Harmony库简介","slug":"一、harmony库简介","link":"#一、harmony库简介","children":[]},{"level":2,"title":"二、创建模组","slug":"二、创建模组","link":"#二、创建模组","children":[]},{"level":2,"title":"三、编写补丁","slug":"三、编写补丁","link":"#三、编写补丁","children":[{"level":3,"title":"1. 安装Harmony模组","slug":"_1-安装harmony模组","link":"#_1-安装harmony模组","children":[]},{"level":3,"title":"2. 编写About.xml文件","slug":"_2-编写about-xml文件","link":"#_2-编写about-xml文件","children":[]},{"level":3,"title":"3. 创建C#项目","slug":"_3-创建c-项目","link":"#_3-创建c-项目","children":[]},{"level":3,"title":"4. 添加Harmony库引用","slug":"_4-添加harmony库引用","link":"#_4-添加harmony库引用","children":[]},{"level":3,"title":"5. 反编译查看目标方法逻辑","slug":"_5-反编译查看目标方法逻辑","link":"#_5-反编译查看目标方法逻辑","children":[]},{"level":3,"title":"6. 编写补丁代码","slug":"_6-编写补丁代码","link":"#_6-编写补丁代码","children":[]},{"level":3,"title":"7. 编译项目并测试","slug":"_7-编译项目并测试","link":"#_7-编译项目并测试","children":[]}]},{"level":2,"title":"四、总结","slug":"四、总结","link":"#四、总结","children":[]}],"git":{"createdTime":1752069415000,"updatedTime":1754564921000,"contributors":[{"name":"renxian","email":"2275568171@qq.com","commits":2}]},"filePathRelative":"blogs/rimword-mod/3/3.md"}');export{g as comp,y as data};
