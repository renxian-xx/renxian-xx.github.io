<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.19">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <link rel="icon" href="/logo.svg"><title>TiDB高内存占用排查 | 散客</title><meta name="description" content="thank">
    <link rel="preload" href="/assets/style-ChPBveyY.css" as="style"><link rel="stylesheet" href="/assets/style-ChPBveyY.css">
    <link rel="modulepreload" href="/assets/app-CiE264yX.js"><link rel="modulepreload" href="/assets/index.html-DyWUrzRK.js">
    <link rel="prefetch" href="/assets/timeline.html-C0Lk3g0A.js" as="script"><link rel="prefetch" href="/assets/posts.html-yyBEX37_.js" as="script"><link rel="prefetch" href="/assets/friendship-link.html-D66nxIB8.js" as="script"><link rel="prefetch" href="/assets/1.html-DskLOxTX.js" as="script"><link rel="prefetch" href="/assets/1.html-CCcRRHr4.js" as="script"><link rel="prefetch" href="/assets/1.html-Cc7u0iSb.js" as="script"><link rel="prefetch" href="/assets/1.html-DMNgt208.js" as="script"><link rel="prefetch" href="/assets/1.html-BvJGlzPc.js" as="script"><link rel="prefetch" href="/assets/1.html-CYaDT32i.js" as="script"><link rel="prefetch" href="/assets/1.html-naniLBH5.js" as="script"><link rel="prefetch" href="/assets/1.html-xvZ_Fz7U.js" as="script"><link rel="prefetch" href="/assets/index.html-Bbo2klxZ.js" as="script"><link rel="prefetch" href="/assets/index.html-HDO2sPOQ.js" as="script"><link rel="prefetch" href="/assets/index.html-CalH6I_v.js" as="script"><link rel="prefetch" href="/assets/index.html-CVhgHSP0.js" as="script"><link rel="prefetch" href="/assets/index.html-Day46LFZ.js" as="script"><link rel="prefetch" href="/assets/index.html-DNfQYyvL.js" as="script"><link rel="prefetch" href="/assets/1.html-DswhFIJG.js" as="script"><link rel="prefetch" href="/assets/0.html-Bv0ycOOD.js" as="script"><link rel="prefetch" href="/assets/3.html-96XX2Qiy.js" as="script"><link rel="prefetch" href="/assets/2.html-CMS8oz4E.js" as="script"><link rel="prefetch" href="/assets/404.html-DnU8LKYT.js" as="script"><link rel="prefetch" href="/assets/Valine.min-_LyT3bfY.js" as="script"><link rel="prefetch" href="/assets/giscus-aTimukGI-DWEKOTfS.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container series--no show-catalog"><header class="navbar-container not-open"><div class="navbar-inner"><div class="site-brand nav-item"><img class="logo" src="/logo.svg" alt="散客"><a href="/" class="site-name can-hide">散客</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/" class="link" aria-label="首页"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->首页<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/categories/huanshijiemozukaifa/1.html" class="link" aria-label="分类"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->分类<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/tags/Mod/1.html" class="link" aria-label="标签"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->标签<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/timeline.html" class="link" aria-label="时间线"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->时间线<!--]--></span></span><!--[--><!--]--></a></div><!--]--><!----><span class="xicon-container btn-toggle-dark-mode btn--dark-mode navbar-links__item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span><ul class="social-links navbar-links__item"><!--[--><li class="social-item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:25px;height:25px;"><path d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.71 3.71 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45a3 3 0 0 0 4.08 1.16a2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76a5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7a5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2z" fill-rule="evenodd" fill="currentColor"></path></svg></li><!--]--></ul></nav><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></div></header><!----><!----><!----><div class="theme-main" style=""><!----><!--[--><main class="page-container"><div class="page-content"><h1 class="page-title">TiDB高内存占用排查</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->renxian<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2025/09/17<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/categories/shujuku/1.html" class="">数据库</a><!--]--><!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M10 14a4 4 0 1 1 4-4a4.005 4.005 0 0 1-4 4zm0-6a2 2 0 1 0 1.998 2.004A2.002 2.002 0 0 0 10 8z" fill="currentColor"></path><path d="M16.644 29.415L2.586 15.354A2 2 0 0 1 2 13.941V4a2 2 0 0 1 2-2h9.941a2 2 0 0 1 1.414.586l14.06 14.058a2 2 0 0 1 0 2.828l-9.943 9.943a2 2 0 0 1-2.829 0zM4 4v9.942L18.058 28L28 18.058L13.942 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/tags/TiDB/1.html" class="">TiDB</a><!--]--><!--]--></span></span><!----></div><div class="theme-reco-md-content"><div><h2 id="_1-背景" tabindex="-1"><a class="header-anchor" href="#_1-背景"><span>1. 背景</span></a></h2><p>前不久我们的平台应用经常出现前端页面卡顿，接口调用报错的情况，让我去排查下问题。</p><p>于是按照常规的思路，先看服务日志，在日志中发现有大量的数据库连接被拒绝的错误日志：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Caused by: java.net.ConnectException: Connection refused (Connection refused)</span>
<span class="line">at java.net.PlainSocketImpl.socketConnect(Native Method)</span>
<span class="line">at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:476)</span>
<span class="line">at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:218)</span>
<span class="line">at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:200)</span>
<span class="line">at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:394)</span>
<span class="line">at java.net.Socket.connect(Socket.java:606)</span>
<span class="line">at com.mysql.cj.protocol.StandardSocketFactory.connect(StandardSocketFactory.java:153)</span>
<span class="line">at com.mysql.cj.protocol.a.NativeSocketConnection.connect(NativeSocketConnection.java:62)</span>
<span class="line">... 9 common frames omitted</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后开始查看网络问题，测试与服务器与数据库的连通性，发现没有问题，能ping通，端口也是通的。应用服务器的状态也是正常的。( 忘截图了)</p><p>接着就是查看数据库的状态，一连上就发现内存基本吃满了，占用最高的为tikv-server，查看日志发现存在OOM的情况，基本可以断定这就是无法建立连接的原因了。</p><p><img src="/assets/img-CRmGCyOy.png" alt="数据库内存状态.png"></p><p>由于平台建设还不全面，监控也不完善，内网环境还没法发送告警，也就没有发现数据库的问题。</p><h2 id="_2-排查过程" tabindex="-1"><a class="header-anchor" href="#_2-排查过程"><span>2. 排查过程</span></a></h2><h3 id="_2-1-查看tidb-server内存相关的参数" tabindex="-1"><a class="header-anchor" href="#_2-1-查看tidb-server内存相关的参数"><span>2.1 查看tidb-server内存相关的参数</span></a></h3><p>按理说数据库都会限制内存使用的，不应该会占用过多的内存，大概率是设置得不合理。</p><p>查看tidb_server_memory_limit的值：80%。</p><p><img src="data:image/png;base64,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" alt="数据库内存限制.png"></p><p>查看数据库GC的情况，发现GC_LAST时间为0001-01-01 00:00:00，也就是没有触发GC，当前tidb-server的内存占用确实也没有达到限制值。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> INFORMATION_SCHEMA<span class="token punctuation">.</span>CLUSTER_MEMORY_USAGE</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="/assets/GC%E6%83%85%E5%86%B5-DJG27dKg.png" alt="GC情况.png"></p><p>尝试下调这个参数到60%，然后重启tidb-server，观察内存变化。</p><p><img src="data:image/png;base64,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" alt="tidb-server内存下调.png"></p><p><img src="/assets/img_2-D08mubUz.png" alt="下调后内存变化.png"></p><p>发现果然没有效果，所以我们需要把重心放到tikv-server上。</p><h3 id="_2-2-查看tikv-server内存相关的参数" tabindex="-1"><a class="header-anchor" href="#_2-2-查看tikv-server内存相关的参数"><span>2.2 查看tikv-server内存相关的参数</span></a></h3><p>从tidb的metrics中查看kv内存相关的数据，发现tikv_engine_block_cache_size_bytes占用了57G的内存。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">tikv_engine_block_cache_size_bytes{cf=&quot;all&quot;,db=&quot;kv&quot;} 61378059808</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>在官方文档上搜索相关参数：</p><p><img src="/assets/storage.block-cache.capacity%E5%8F%82%E6%95%B0%E6%8F%8F%E8%BF%B0-B05mjGjV.png" alt="storage.block-cache.capacity参数描述.png"></p><p>我们使用的engine为raft-kv，默认值为系统内存的45%，而我们的服务器内存为128G，70%就是57G左右，但是由于服务器还部署了其他服务，所以这个值显然过高了。</p><p><img src="/assets/kv%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E-Cvk6wmSl.png" alt="kv存储引擎.png"></p><p>尝试下调这个参数到20G，然后重启tikv-server，观察内存变化。</p><p><img src="/assets/img_4-BSe8mz9b.png" alt="tikv-server相关参数.png"></p><p><img src="/assets/img_3-oUXoQkLA.png" alt="tikv-server调整变化.png"></p><p>果然内存总占用果然下降了，稳定在60多G后不再增长，也不再出现应用服务连不上数据库的情况。</p><p>还有一个重要参数memory-usage-limit需要了解一下，我们服务器内存为128G，75%就是96G，显然我们服务器是没法达到这个值，所以这个参数也需要下调。</p><p><img src="/assets/memory-usage-limit%E5%8F%82%E6%95%B0-BuLbZ1X0.png" alt="memory-usage-limit参数.png"></p><p><img src="/assets/memory-usage-limit%E6%83%85%E5%86%B5-DYFVXdJK.png" alt="memory-usage-limit情况.png"></p><h2 id="_3-总结" tabindex="-1"><a class="header-anchor" href="#_3-总结"><span>3. 总结</span></a></h2><p>通过这次排查，发现数据库的内存参数设置不合理，导致内存占用过高，进而引发应用服务无法连接数据库的问题。通过下调tikv-server的缓存相关参数，成功解决了问题。</p></div></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->上次更新于 2025/9/17 23:19:56<!--]--></span></span></div></footer><!----><!----></div><div class="page-catalog-container"><h5 class="tip">ON THIS PAGE</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/db/tidb/#_1-背景" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="1. 背景"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->1. 背景<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/db/tidb/#_2-排查过程" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2. 排查过程"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2. 排查过程<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/db/tidb/#_2-1-查看tidb-server内存相关的参数" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.1 查看tidb-server内存相关的参数"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.1 查看tidb-server内存相关的参数<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/db/tidb/#_2-2-查看tikv-server内存相关的参数" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="2.2 查看tikv-server内存相关的参数"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2.2 查看tikv-server内存相关的参数<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/db/tidb/#_3-总结" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="3. 总结"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->3. 总结<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></main><!--]--></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-CiE264yX.js" defer></script>
  </body>
</html>
